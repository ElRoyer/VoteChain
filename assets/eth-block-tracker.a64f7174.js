import{c as o}from"./@account-abstraction.16fd1566.js";import{j as p}from"./json-rpc-random-id.51bc6534.js";import{p as B}from"./pify.8425b695.js";import{s as g,d as L}from"./@metamask.9b2b42ff.js";var y={},l={},a={},T=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(a,"__esModule",{value:!0});a.BaseBlockTracker=void 0;const w=T(g),R=1e3,I=(t,e)=>t+e,_=["sync","latest"];class P extends w.default{constructor(e){super(),this._blockResetDuration=e.blockResetDuration||20*R,this._currentBlock=null,this._isRunning=!1,this._onNewListener=this._onNewListener.bind(this),this._onRemoveListener=this._onRemoveListener.bind(this),this._resetCurrentBlock=this._resetCurrentBlock.bind(this),this._setupInternalEvents()}async destroy(){this._cancelBlockResetTimeout(),await this._maybeEnd(),super.removeAllListeners()}isRunning(){return this._isRunning}getCurrentBlock(){return this._currentBlock}async getLatestBlock(){return this._currentBlock?this._currentBlock:await new Promise(r=>this.once("latest",r))}removeAllListeners(e){return e?super.removeAllListeners(e):super.removeAllListeners(),this._setupInternalEvents(),this._onRemoveListener(),this}_setupInternalEvents(){this.removeListener("newListener",this._onNewListener),this.removeListener("removeListener",this._onRemoveListener),this.on("newListener",this._onNewListener),this.on("removeListener",this._onRemoveListener)}_onNewListener(e){_.includes(e)&&this._maybeStart()}_onRemoveListener(){this._getBlockTrackerEventCount()>0||this._maybeEnd()}async _maybeStart(){this._isRunning||(this._isRunning=!0,this._cancelBlockResetTimeout(),await this._start(),this.emit("_started"))}async _maybeEnd(){!this._isRunning||(this._isRunning=!1,this._setupBlockResetTimeout(),await this._end(),this.emit("_ended"))}_getBlockTrackerEventCount(){return _.map(e=>this.listenerCount(e)).reduce(I)}_newPotentialLatest(e){const r=this._currentBlock;r&&h(e)<=h(r)||this._setCurrentBlock(e)}_setCurrentBlock(e){const r=this._currentBlock;this._currentBlock=e,this.emit("latest",e),this.emit("sync",{oldBlock:r,newBlock:e})}_setupBlockResetTimeout(){this._cancelBlockResetTimeout(),this._blockResetTimeout=setTimeout(this._resetCurrentBlock,this._blockResetDuration),this._blockResetTimeout.unref&&this._blockResetTimeout.unref()}_cancelBlockResetTimeout(){this._blockResetTimeout&&clearTimeout(this._blockResetTimeout)}_resetCurrentBlock(){this._currentBlock=null}}a.BaseBlockTracker=P;function h(t){return Number.parseInt(t,16)}var m={};(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.createModuleLogger=t.projectLogger=void 0;const e=L;Object.defineProperty(t,"createModuleLogger",{enumerable:!0,get:function(){return e.createModuleLogger}}),t.projectLogger=(0,e.createProjectLogger)("eth-block-tracker")})(m);var v=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(l,"__esModule",{value:!0});l.PollingBlockTracker=void 0;const E=v(p),j=v(B),S=a,d=m,k=(0,d.createModuleLogger)(d.projectLogger,"polling-block-tracker"),C=(0,E.default)(),M=1e3;class D extends S.BaseBlockTracker{constructor(e={}){var r;if(!e.provider)throw new Error("PollingBlockTracker - no provider specified.");super({blockResetDuration:(r=e.blockResetDuration)!==null&&r!==void 0?r:e.pollingInterval}),this._provider=e.provider,this._pollingInterval=e.pollingInterval||20*M,this._retryTimeout=e.retryTimeout||this._pollingInterval/10,this._keepEventLoopActive=e.keepEventLoopActive===void 0?!0:e.keepEventLoopActive,this._setSkipCacheFlag=e.setSkipCacheFlag||!1}async checkForLatestBlock(){return await this._updateLatestBlock(),await this.getLatestBlock()}async _start(){this._synchronize()}async _end(){}async _synchronize(){for(var e;this._isRunning;)try{await this._updateLatestBlock();const r=f(this._pollingInterval,!this._keepEventLoopActive);this.emit("_waitingForNextIteration"),await r}catch(r){const i=new Error(`PollingBlockTracker - encountered an error while attempting to update latest block:
${(e=r.stack)!==null&&e!==void 0?e:r}`);try{this.emit("error",i)}catch{console.error(i)}const n=f(this._retryTimeout,!this._keepEventLoopActive);this.emit("_waitingForNextIteration"),await n}}async _updateLatestBlock(){const e=await this._fetchLatestBlock();this._newPotentialLatest(e)}async _fetchLatestBlock(){const e={jsonrpc:"2.0",id:C(),method:"eth_blockNumber",params:[]};this._setSkipCacheFlag&&(e.skipCache=!0),k("Making request",e);const r=await(0,j.default)(i=>this._provider.sendAsync(e,i))();if(k("Got response",r),r.error)throw new Error(`PollingBlockTracker - encountered error fetching block:
${r.error.message}`);return r.result}}l.PollingBlockTracker=D;function f(t,e){return new Promise(r=>{const i=setTimeout(r,t);i.unref&&e&&i.unref()})}var u={},$=o&&o.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(u,"__esModule",{value:!0});u.SubscribeBlockTracker=void 0;const A=$(p),O=a,N=(0,A.default)();class F extends O.BaseBlockTracker{constructor(e={}){if(!e.provider)throw new Error("SubscribeBlockTracker - no provider specified.");super(e),this._provider=e.provider,this._subscriptionId=null}async checkForLatestBlock(){return await this.getLatestBlock()}async _start(){if(this._subscriptionId===void 0||this._subscriptionId===null)try{const e=await this._call("eth_blockNumber");this._subscriptionId=await this._call("eth_subscribe","newHeads"),this._provider.on("data",this._handleSubData.bind(this)),this._newPotentialLatest(e)}catch(e){this.emit("error",e)}}async _end(){if(this._subscriptionId!==null&&this._subscriptionId!==void 0)try{await this._call("eth_unsubscribe",this._subscriptionId),this._subscriptionId=null}catch(e){this.emit("error",e)}}_call(e,...r){return new Promise((i,n)=>{this._provider.sendAsync({id:N(),method:e,params:r,jsonrpc:"2.0"},(s,c)=>{s?n(s):i(c.result)})})}_handleSubData(e,r){var i;r.method==="eth_subscription"&&((i=r.params)===null||i===void 0?void 0:i.subscription)===this._subscriptionId&&this._newPotentialLatest(r.params.result.number)}}u.SubscribeBlockTracker=F;var b={};Object.defineProperty(b,"__esModule",{value:!0});(function(t){var e=o&&o.__createBinding||(Object.create?function(i,n,s,c){c===void 0&&(c=s),Object.defineProperty(i,c,{enumerable:!0,get:function(){return n[s]}})}:function(i,n,s,c){c===void 0&&(c=s),i[c]=n[s]}),r=o&&o.__exportStar||function(i,n){for(var s in i)s!=="default"&&!Object.prototype.hasOwnProperty.call(n,s)&&e(n,i,s)};Object.defineProperty(t,"__esModule",{value:!0}),r(l,t),r(u,t),r(b,t)})(y);export{y as d};
